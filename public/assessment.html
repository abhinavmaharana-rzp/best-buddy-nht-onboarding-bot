<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proctored Assessment - Razorpay Onboarding</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .assessment-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .assessment-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .assessment-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .assessment-content {
            padding: 40px;
        }
        
        .proctoring-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .proctoring-status.recording::before {
            content: '‚óè';
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .warning-banner {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .instructions-list {
            list-style: none;
            padding: 0;
        }
        
        .instructions-list li {
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .instructions-list li:last-child {
            border-bottom: none;
        }
        
        .instructions-list li::before {
            content: '‚ö†Ô∏è';
            font-size: 18px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .assessment-iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #1f2937;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            z-index: 1000;
        }
        
        .timer.warning {
            background: #dc2626;
            animation: pulse 1s infinite;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .violation-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fef2f2;
            border: 2px solid #fca5a5;
            color: #991b1b;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 10000;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center text-white">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p id="loadingText">Initializing proctored assessment...</p>
        </div>
    </div>

    <!-- Proctoring Status -->
    <div id="proctoringStatus" class="proctoring-status hidden">
        <span>üî¥</span>
        <span>Recording in Progress</span>
    </div>

    <!-- Timer -->
    <div id="timer" class="timer hidden">
        <span id="timeRemaining">00:00</span>
    </div>

    <!-- Assessment Container -->
    <div class="assessment-container">
        <div class="assessment-card">
            <!-- Assessment Header -->
            <div class="assessment-header">
                <h1 id="assessmentTitle" class="text-3xl font-bold mb-2">Proctored Assessment</h1>
                <p id="assessmentDescription" class="text-lg opacity-90">Please complete this assessment under proctored conditions</p>
            </div>

            <!-- Assessment Content -->
            <div class="assessment-content">
                <!-- Pre-Assessment Instructions -->
                <div id="preAssessment" class="text-center">
                    <div class="warning-banner">
                        <h3 class="text-lg font-semibold mb-2">‚ö†Ô∏è Important Instructions</h3>
                        <p class="text-sm">This is a proctored assessment. You will be monitored throughout the session.</p>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4">Assessment Rules</h3>
                        <ul class="instructions-list text-left max-w-2xl mx-auto">
                            <li>Do not switch tabs or open new windows during the assessment</li>
                            <li>Do not use copy-paste functionality</li>
                            <li>Do not right-click on the page</li>
                            <li>Ensure your screen sharing is working properly</li>
                            <li>You will be monitored throughout the assessment</li>
                            <li>Any violations will result in warnings or termination</li>
                            <li>You have <span id="timeLimit">30</span> minutes to complete this assessment</li>
                        </ul>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-2">Assessment Details</h3>
                        <div class="bg-gray-50 p-4 rounded-lg max-w-md mx-auto">
                            <p><strong>Topic:</strong> <span id="topicName">-</span></p>
                            <p><strong>Passing Score:</strong> <span id="passingScore">80%</span></p>
                            <p><strong>Time Limit:</strong> <span id="timeLimitDisplay">30 minutes</span></p>
                            <p><strong>Max Attempts:</strong> <span id="maxAttempts">3</span></p>
                        </div>
                    </div>

                    <button id="startAssessmentBtn" class="btn-primary">
                        Start Proctored Assessment
                    </button>
                </div>

                <!-- Assessment Iframe -->
                <div id="assessmentContent" class="hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">Complete the assessment below:</h3>
                        <p class="text-sm text-gray-600">Your screen is being recorded for proctoring purposes.</p>
                    </div>
                    
                    <!-- Google Forms iframe with enhanced CSP handling -->
                    <div class="relative">
                        <iframe 
                            id="assessmentIframe" 
                            class="assessment-iframe" 
                            src=""
                            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation allow-modals"
                            referrerpolicy="no-referrer-when-downgrade"
                            allow="fullscreen">
                        </iframe>
                        
                        <!-- Loading indicator -->
                        <div id="iframeLoading" class="absolute inset-0 bg-gray-50 border-2 border-gray-200 rounded-lg p-4 flex items-center justify-center">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                <p class="text-sm text-gray-600">Loading assessment form...</p>
                            </div>
                        </div>
                        
                        <!-- CSP warning overlay (hidden by default) -->
                        <div id="cspWarning" class="hidden absolute inset-0 bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-yellow-600 text-4xl mb-2">‚ö†Ô∏è</div>
                                <h4 class="font-semibold text-yellow-800 mb-2">Form Loading Issue</h4>
                                <p class="text-sm text-yellow-700 mb-4">
                                    The Google Form may not load due to security restrictions.<br>
                                    We'll use an alternative method to track your progress.
                                </p>
                                <button id="continueWithoutIframe" class="btn-primary">
                                    Continue Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Assessment completion section -->
                    <div class="mt-4 text-center">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p class="text-sm text-blue-800 mb-2">
                                <strong>Assessment Instructions:</strong><br>
                                Complete the form above and your score will be automatically calculated.
                            </p>
                        </div>
                        
                        <div class="text-sm text-gray-600 mb-4">
                            <p>üìù Complete the assessment in the form above</p>
                            <p>‚è±Ô∏è Your screen is being recorded for proctoring</p>
                            <p>‚úÖ Score will be automatically calculated when you submit</p>
                            <p>üîÑ If automatic detection fails, use the button below</p>
                        </div>
                        
                        <!-- Manual completion button (shown after timeout or iframe failure) -->
                        <button id="completeAssessmentBtn" class="btn-primary hidden">
                            Complete Assessment
                        </button>
                    </div>
                </div>

                <!-- Completion Message -->
                <div id="completionMessage" class="hidden text-center p-8">
                    <div class="text-green-600 text-6xl mb-4">‚úÖ</div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Assessment Submitted Successfully!</h2>
                    <p class="text-gray-600 mb-6">Thank you for completing the assessment. Your responses have been recorded and will be reviewed.</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-blue-800">
                            <strong>Next Steps:</strong> You will receive a notification in Slack once your assessment is scored and reviewed.
                        </p>
                    </div>
                </div>

                <!-- Post-Assessment -->
                <div id="postAssessment" class="hidden text-center">
                    <div id="successMessage" class="hidden">
                        <div class="text-green-600 text-6xl mb-4">‚úÖ</div>
                        <h3 class="text-2xl font-bold text-green-800 mb-2">Assessment Completed Successfully!</h3>
                        <p class="text-green-600 mb-4">Congratulations! You have passed the assessment with a score of <span id="finalScore">-</span>%</p>
                        <p class="text-gray-600">Your results have been submitted for review.</p>
                    </div>

                    <div id="failureMessage" class="hidden">
                        <div class="text-red-600 text-6xl mb-4">‚ùå</div>
                        <h3 class="text-2xl font-bold text-red-800 mb-2">Assessment Not Passed</h3>
                        <p class="text-red-600 mb-4">Unfortunately, you did not achieve the required passing score of <span id="requiredScore">80</span>%</p>
                        <p class="text-gray-600 mb-4">Your score: <span id="userScore">-</span>%</p>
                        <p class="text-gray-600">Please prepare well and try again. You can retake this assessment after reviewing the material.</p>
                    </div>

                    <div id="terminatedMessage" class="hidden">
                        <div class="text-red-600 text-6xl mb-4">üö´</div>
                        <h3 class="text-2xl font-bold text-red-800 mb-2">Assessment Terminated</h3>
                        <p class="text-red-600 mb-4">Your assessment has been terminated due to multiple violations.</p>
                        <p class="text-gray-600">Please contact your administrator for further assistance.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Violation Warning Modal -->
    <div id="violationWarning" class="violation-warning hidden">
        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-xl font-bold mb-2">Violation Detected</h3>
        <p id="violationMessage" class="mb-4">A violation has been detected during your assessment.</p>
        <p class="text-sm text-gray-600">Please review the rules and continue with the assessment.</p>
    </div>

    <!-- Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <script src="/js/face-detection.js"></script>
    <script src="/js/proctoring.js"></script>
    <script>
        class AssessmentManager {
            constructor() {
                this.proctoringSystem = null;
                this.assessmentConfig = null;
                this.timeRemaining = 0;
                this.timerInterval = null;
                this.assessmentId = null;
                this.sessionId = null;
                
                this.init();
            }

            async init() {
                try {
                    // Get assessment parameters from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    this.assessmentId = urlParams.get('assessmentId');
                    this.sessionId = urlParams.get('sessionId');
                    
                    if (!this.assessmentId) {
                        throw new Error('Assessment ID is required');
                    }

                    // Load assessment configuration
                    await this.loadAssessmentConfig();
                    
                    // Initialize proctoring system
                    this.proctoringSystem = new ProctoringSystem(this.assessmentConfig);
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Hide loading overlay
                    this.hideLoading();
                    
                } catch (error) {
                    console.error('Failed to initialize assessment:', error);
                    this.showError('Failed to initialize assessment. Please try again.');
                }
            }

            async loadAssessmentConfig() {
                try {
                    console.log(`üîç Loading assessment config for ID: ${this.assessmentId}`);
                    
                    // Validate assessment ID format
                    if (!this.isValidObjectId(this.assessmentId)) {
                        throw new Error('Invalid assessment ID format. Please check the URL and try again.');
                    }
                    
                    const response = await fetch(`/api/assessment/config/${this.assessmentId}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('Assessment config error:', errorData);
                        
                        if (response.status === 404) {
                            if (errorData.code === 'ASSESSMENT_NOT_FOUND') {
                                throw new Error('Assessment not found. This assessment may have expired or been deleted. Please start a new assessment.');
                            } else if (errorData.code === 'CONFIG_NOT_FOUND') {
                                throw new Error('Assessment configuration not found. Please contact support.');
                            } else {
                                throw new Error('Assessment not found. Please start a new assessment.');
                            }
                        } else if (response.status === 400) {
                            throw new Error('Invalid assessment ID. Please check the URL and try again.');
                        } else {
                            throw new Error(`Failed to load assessment configuration (${response.status}). Please try again.`);
                        }
                    }
                    
                    const config = await response.json();
                    console.log('‚úÖ Assessment config loaded:', config.taskTitle);
                    
                    // Load the full assessment data including proctoring config
                    const fullResponse = await fetch('/api/assessment/data');
                    if (!fullResponse.ok) {
                        console.warn('‚ö†Ô∏è Failed to load full assessment data, using basic config');
                        // Continue with basic config if full data fails
                        this.assessmentConfig = {
                            ...config,
                            proctoring: {
                                screenRecording: { enabled: true, quality: "medium", frameRate: 1 },
                                violations: {
                                    tabSwitch: { enabled: true, maxAllowed: 3, severity: "medium" },
                                    windowFocusLoss: { enabled: true, maxAllowed: 5, severity: "low" },
                                    copyPaste: { enabled: true, maxAllowed: 0, severity: "high" },
                                    rightClick: { enabled: true, maxAllowed: 0, severity: "high" }
                                }
                            },
                            messages: {
                                start: { title: "Assessment Starting", content: "Your assessment is about to begin." },
                                instructions: ["Follow all assessment rules", "Do not switch tabs", "Complete within time limit"],
                                success: { title: "Assessment Completed", content: "Congratulations on completing the assessment." },
                                failure: { title: "Assessment Not Passed", content: "Please review the material and try again." }
                            }
                        };
                    } else {
                        const fullData = await fullResponse.json();
                        
                        // Merge the config with the full assessment data
                        this.assessmentConfig = {
                            ...config,
                            proctoring: fullData.proctoring,
                            messages: fullData.messages
                        };
                    }
                    
                    this.updateAssessmentInfo();
                    
                } catch (error) {
                    console.error('‚ùå Error loading assessment config:', error);
                    throw error;
                }
            }
            
            isValidObjectId(id) {
                return /^[0-9a-fA-F]{24}$/.test(id);
            }

            updateAssessmentInfo() {
                const config = this.assessmentConfig;
                
                document.getElementById('assessmentTitle').textContent = config.taskTitle;
                document.getElementById('assessmentDescription').textContent = config.description;
                document.getElementById('topicName').textContent = config.taskTitle;
                document.getElementById('passingScore').textContent = config.passingScore + '%';
                document.getElementById('timeLimit').textContent = config.timeLimit;
                document.getElementById('timeLimitDisplay').textContent = config.timeLimit + ' minutes';
                document.getElementById('maxAttempts').textContent = config.maxAttempts;
                
                this.timeRemaining = config.timeLimit * 60; // Convert to seconds
            }

            setupEventListeners() {
                document.getElementById('startAssessmentBtn').addEventListener('click', () => {
                    this.startAssessment();
                });
                
                document.getElementById('completeAssessmentBtn').addEventListener('click', () => {
                    this.handleFormSubmission();
                });
                
                // Handle CSP warning and continue without iframe
                document.getElementById('continueWithoutIframe').addEventListener('click', () => {
                    this.continueWithoutIframe();
                });
            }

            async startAssessment() {
                try {
                    // Start proctoring
                    await this.proctoringSystem.startAssessment();
                    
                    // Show proctoring status
                    document.getElementById('proctoringStatus').classList.remove('hidden');
                    document.getElementById('proctoringStatus').classList.add('recording');
                    
                    // Start timer
                    this.startTimer();
                    
                    // Load assessment iframe
                    this.loadAssessmentIframe();
                    
                    // Set a timeout to automatically complete after time limit + 5 minutes
                    this.assessmentTimeout = setTimeout(() => {
                        console.log('Assessment timeout reached, auto-completing...');
                        this.handleFormSubmission();
                    }, (this.assessmentConfig.timeLimit + 5) * 60 * 1000);
                    
                    // Hide pre-assessment, show assessment content
                    document.getElementById('preAssessment').classList.add('hidden');
                    document.getElementById('assessmentContent').classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Failed to start assessment:', error);
                    this.showError('Failed to start assessment. Please try again.');
                }
            }

            loadAssessmentIframe() {
                const iframe = document.getElementById('assessmentIframe');
                const cspWarning = document.getElementById('cspWarning');
                const iframeLoading = document.getElementById('iframeLoading');
                
                // Show loading indicator
                iframeLoading.classList.remove('hidden');
                cspWarning.classList.add('hidden');
                
                // Load custom assessment form instead of Google Forms
                const customFormUrl = `/custom-assessment.html?assessmentId=${this.assessmentId}&sessionId=${this.sessionId}`;
                iframe.src = customFormUrl;
                
                // Set up iframe load detection with CSP handling
                let loadTimeout;
                let hasLoaded = false;
                let checkCount = 0;
                const maxChecks = 10; // Check for 10 seconds
                
                const checkIfLoaded = () => {
                    checkCount++;
                    try {
                        // Try to access iframe content to see if it loaded
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.readyState === 'complete') {
                            console.log('Assessment iframe loaded successfully');
                            hasLoaded = true;
                            clearTimeout(loadTimeout);
                            iframeLoading.classList.add('hidden');
                            cspWarning.classList.add('hidden');
                            this.setupFormSubmissionDetection();
                            return;
                        }
                    } catch (error) {
                        // Cross-origin access blocked (expected)
                        console.log('Cross-origin access blocked (expected)');
                    }
                    
                    // If not loaded and haven't exceeded max checks, try again
                    if (!hasLoaded && checkCount < maxChecks) {
                        setTimeout(checkIfLoaded, 1000);
                    } else if (!hasLoaded) {
                        console.log('Assessment iframe loading timeout - showing fallback');
                        this.handleIframeLoadFailure();
                    }
                };
                
                iframe.onload = () => {
                    console.log('Assessment iframe onload event fired');
                    checkIfLoaded();
                };
                
                iframe.onerror = () => {
                    console.log('Assessment iframe failed to load');
                    hasLoaded = false;
                    clearTimeout(loadTimeout);
                    this.handleIframeLoadFailure();
                };
                
                // Start checking after 2 seconds
                loadTimeout = setTimeout(() => {
                    if (!hasLoaded) {
                        console.log('Assessment iframe loading timeout - starting checks');
                        checkIfLoaded();
                    }
                }, 2000);
            }
            
            handleIframeLoadFailure() {
                const iframeLoading = document.getElementById('iframeLoading');
                const cspWarning = document.getElementById('cspWarning');
                
                iframeLoading.classList.add('hidden');
                cspWarning.classList.remove('hidden');
                
                // Show the complete assessment button as fallback
                document.getElementById('completeAssessmentBtn').classList.remove('hidden');
                
                // Show notification about alternative method
                this.showNotification('Form loading failed. You can complete the assessment using the button below.', 'warning');
            }
            
            continueWithoutIframe() {
                const cspWarning = document.getElementById('cspWarning');
                const iframe = document.getElementById('assessmentIframe');
                
                // Hide the warning
                cspWarning.classList.add('hidden');
                
                // Show the complete assessment button
                document.getElementById('completeAssessmentBtn').classList.remove('hidden');
                
                // Show instructions
                this.showNotification('Assessment ready. Click "Complete Assessment" when you have finished the form.', 'info');
                
                // Try to load the form in a popup window for reference
                const formUrl = this.assessmentConfig.googleFormUrl;
                const popup = window.open(formUrl, 'assessmentForm', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                if (popup) {
                    // Focus on the popup
                    popup.focus();
                }
            }

            setupFormSubmissionDetection() {
                const iframe = document.getElementById('assessmentIframe');
                let lastUrl = '';
                
                // Listen for postMessage from custom assessment form
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'ASSESSMENT_COMPLETED') {
                        console.log('Assessment completed via postMessage!', event.data);
                        this.handleCustomAssessmentCompletion(event.data.data);
                    }
                });
                
                // Poll for form submission detection (fallback)
                let checkCount = 0;
                const maxChecks = 30; // Check for 1 minute (30 * 2 seconds)
                
                this.formCheckInterval = setInterval(() => {
                    checkCount++;
                    
                    try {
                        // Check if iframe URL has changed (form submitted)
                        const currentUrl = iframe.contentWindow.location.href;
                        
                        // Debug logging
                        if (currentUrl !== lastUrl) {
                            console.log('URL changed:', currentUrl);
                            lastUrl = currentUrl;
                        }
                        
                        // Check for Google Forms submission patterns
                        if (this.isFormSubmitted(currentUrl)) {
                            console.log('Form submission detected!');
                            this.handleFormSubmission();
                        }
                    } catch (error) {
                        // Cross-origin error is expected, ignore
                        console.log('Cross-origin access blocked (expected)');
                    }
                    
                    // Stop checking after max attempts and show manual button
                    if (checkCount >= maxChecks) {
                        console.log('Form submission detection timeout - showing manual button');
                        clearInterval(this.formCheckInterval);
                        document.getElementById('completeAssessmentBtn').classList.remove('hidden');
                        this.showNotification('Form submission detection timed out. Please click "Complete Assessment" when finished.', 'info');
                    }
                }, 2000); // Reduced frequency to avoid performance issues

                // Also listen for iframe navigation changes
                iframe.addEventListener('load', () => {
                    try {
                        const currentUrl = iframe.contentWindow.location.href;
                        console.log('Iframe loaded with URL:', currentUrl);
                        
                        if (this.isFormSubmitted(currentUrl)) {
                            console.log('Form submission detected via navigation!');
                            this.handleFormSubmission();
                        }
                    } catch (error) {
                        // Cross-origin error is expected, ignore
                        console.log('Cross-origin access blocked on load (expected)');
                    }
                });
            }

            isFormSubmitted(url) {
                // Check for various Google Forms submission patterns
                const submissionPatterns = [
                    'formResponse',           // Standard Google Forms response
                    'thankyou',              // Thank you page
                    'submitted',             // Submitted page
                    'viewform?usp=pp_url',   // Google Forms response with parameters
                    'formResponse?',         // Response with query parameters
                    'thanks',                // Thanks page
                    'complete',              // Complete page
                    'success'                // Success page
                ];
                
                return submissionPatterns.some(pattern => url.includes(pattern));
            }

            async handleCustomAssessmentCompletion(assessmentData) {
                console.log('Handling custom assessment completion...', assessmentData);
                
                // Clear the form check interval
                if (this.formCheckInterval) {
                    clearInterval(this.formCheckInterval);
                    console.log('Cleared form check interval');
                }
                
                // Clear the timeout
                if (this.assessmentTimeout) {
                    clearTimeout(this.assessmentTimeout);
                    console.log('Cleared assessment timeout');
                }
                
                // Show loading state
                console.log('Showing loading state...');
                this.showLoading('Processing your assessment results...');
                
                try {
                    const { score, rawScore, totalQuestions, passed, timeSpent } = assessmentData;
                    
                    console.log(`Assessment completed - Score: ${rawScore}/${totalQuestions} (${score}%), Passed: ${passed}`);
                    
                    // Stop proctoring with actual score
                    if (this.proctoringSystem) {
                        console.log('Stopping proctoring system...');
                        try {
                            await this.proctoringSystem.completeAssessment(score, passed);
                            console.log('Proctoring system stopped');
                        } catch (proctoringError) {
                            console.error('Error stopping proctoring system:', proctoringError);
                            // Force stop proctoring
                            this.forceStopProctoring();
                        }
                    } else {
                        console.log('No proctoring system found');
                    }
                    
                    // Submit assessment results to backend
                    console.log('Submitting assessment results...');
                    await this.submitAssessmentResults(score, passed, rawScore, totalQuestions);
                    console.log('Assessment results submitted');
                    
                    // Show appropriate result message
                    console.log('Showing assessment result...');
                    this.showAssessmentResult(score, passed, rawScore, totalQuestions);
                    
                } catch (error) {
                    console.error('Error processing assessment:', error);
                    this.showError('Error processing your assessment. Please try again.');
                }
            }

            async handleFormSubmission() {
                console.log('Handling form submission...');
                
                // Clear the form check interval
                if (this.formCheckInterval) {
                    clearInterval(this.formCheckInterval);
                    console.log('Cleared form check interval');
                }
                
                // Clear the timeout
                if (this.assessmentTimeout) {
                    clearTimeout(this.assessmentTimeout);
                    console.log('Cleared assessment timeout');
                }
                
                // Show loading state
                console.log('Showing loading state...');
                this.showLoading('Processing your assessment and calculating score...');
                
                try {
                    // Get score from Google Forms integration
                    console.log('Calculating score from Google Forms...');
                    const scoreResult = await this.calculateGoogleFormsScore();
                    
                    if (!scoreResult.success) {
                        throw new Error(scoreResult.error || 'Failed to calculate score');
                    }
                    
                    const { score, rawScore, totalQuestions, passed } = scoreResult;
                    
                    console.log(`Assessment completed - Score: ${rawScore}/${totalQuestions} (${score}%), Passed: ${passed}`);
                    
                    // Stop proctoring with actual score
                    if (this.proctoringSystem) {
                        console.log('Stopping proctoring system...');
                        try {
                            await this.proctoringSystem.completeAssessment(score, passed);
                            console.log('Proctoring system stopped');
                        } catch (proctoringError) {
                            console.error('Error stopping proctoring system:', proctoringError);
                            // Force stop proctoring
                            this.forceStopProctoring();
                        }
                    } else {
                        console.log('No proctoring system found');
                    }
                    
                    // Submit assessment results to backend
                    console.log('Submitting assessment results...');
                    await this.submitAssessmentResults(score, passed, rawScore, totalQuestions);
                    console.log('Assessment results submitted');
                    
                    // Show appropriate result message
                    console.log('Showing assessment result...');
                    this.showAssessmentResult(score, passed, rawScore, totalQuestions);
                    
                } catch (error) {
                    console.error('Error processing assessment:', error);
                    this.showError('Error processing your assessment. Please try again.');
                }
            }

            async calculateGoogleFormsScore() {
                try {
                    console.log('Calculating Google Forms score...');
                    
                    // Call backend to process Google Forms score
                    const response = await fetch('/api/assessment/calculate-score', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            assessmentId: this.assessmentId,
                            formUrl: this.assessmentConfig.googleFormUrl,
                            timeSpent: this.timeSpent,
                            violations: this.proctoringSystem ? this.proctoringSystem.violations.length : 0
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to calculate score');
                    }

                    const result = await response.json();
                    console.log('Google Forms score result:', result);
                    
                    return result;
                } catch (error) {
                    console.error('Error calculating Google Forms score:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            async calculateAssessmentScore() {
                // Calculate score based on various factors
                let baseScore = Math.floor(Math.random() * 40) + 40; // Random base score 40-80
                
                // Adjust based on time spent
                const timeSpent = this.assessmentConfig.timeLimit - (this.timeRemaining / 60);
                if (timeSpent < this.assessmentConfig.timeLimit * 0.5) {
                    baseScore += 10; // Bonus for finishing quickly
                } else if (timeSpent > this.assessmentConfig.timeLimit * 0.9) {
                    baseScore -= 5; // Penalty for taking too long
                }
                
                // Adjust based on violations
                const violations = this.proctoringSystem ? this.proctoringSystem.violations.length : 0;
                baseScore -= violations * 2; // 2 points per violation
                
                // Ensure score is within valid range
                return Math.max(0, Math.min(100, baseScore));
            }

            async submitAssessmentResults(score, passed, rawScore = null, totalQuestions = null) {
                try {
                    const response = await fetch('/api/assessment/complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            assessmentId: this.assessmentId,
                            sessionId: this.sessionId,
                            score: score,
                            passed: passed,
                            rawScore: rawScore,
                            totalQuestions: totalQuestions,
                            timeSpent: this.assessmentConfig.timeLimit - (this.timeRemaining / 60),
                            violations: this.proctoringSystem ? this.proctoringSystem.violations.length : 0,
                            completedAt: new Date().toISOString()
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to submit assessment results');
                    }

                    const result = await response.json();
                    console.log('Assessment results submitted:', result);
                    return result;
                } catch (error) {
                    console.error('Error submitting assessment results:', error);
                    throw error;
                }
            }

            showAssessmentResult(score, passed, rawScore = null, totalQuestions = null) {
                // Hide assessment content
                document.getElementById('assessmentContent').classList.add('hidden');
                
                // Stop the timer
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                
                if (passed) {
                    this.showSuccessMessage(score, rawScore, totalQuestions);
                } else {
                    this.showFailureMessage(score, rawScore, totalQuestions);
                }
            }

            showSuccessMessage(score, rawScore = null, totalQuestions = null) {
                // Hide completion message and show success message
                document.getElementById('completionMessage').classList.add('hidden');
                document.getElementById('postAssessment').classList.remove('hidden');
                document.getElementById('successMessage').classList.remove('hidden');
                document.getElementById('failureMessage').classList.add('hidden');
                document.getElementById('terminatedMessage').classList.add('hidden');
                
                // Update score display
                const violationCount = this.proctoringSystem ? this.proctoringSystem.violations.length : 0;
                if (rawScore && totalQuestions) {
                    document.getElementById('finalScore').textContent = `${rawScore}/${totalQuestions} (${score}%)`;
                } else {
                    document.getElementById('finalScore').textContent = score + '%';
                }
                
                // Add violations info if any
                const successMessage = document.getElementById('successMessage');
                const existingViolationsInfo = successMessage.querySelector('.violations-info');
                if (existingViolationsInfo) {
                    existingViolationsInfo.remove();
                }
                
                if (violationCount > 0) {
                    const violationsInfo = document.createElement('p');
                    violationsInfo.className = 'violations-info text-sm text-yellow-600 mt-2';
                    violationsInfo.textContent = `‚ö†Ô∏è ${violationCount} proctoring violation(s) detected during assessment`;
                    successMessage.appendChild(violationsInfo);
                }
            }

            showFailureMessage(score, rawScore = null, totalQuestions = null) {
                // Hide completion message and show failure message
                document.getElementById('completionMessage').classList.add('hidden');
                document.getElementById('postAssessment').classList.remove('hidden');
                document.getElementById('successMessage').classList.add('hidden');
                document.getElementById('failureMessage').classList.remove('hidden');
                document.getElementById('terminatedMessage').classList.add('hidden');
                
                // Update score displays
                const violationCount = this.proctoringSystem ? this.proctoringSystem.violations.length : 0;
                if (rawScore && totalQuestions) {
                    document.getElementById('userScore').textContent = `${rawScore}/${totalQuestions} (${score}%)`;
                } else {
                    document.getElementById('userScore').textContent = score + '%';
                }
                document.getElementById('requiredScore').textContent = this.assessmentConfig.passingScore;
                
                // Add violations info if any
                const failureMessage = document.getElementById('failureMessage');
                const existingViolationsInfo = failureMessage.querySelector('.violations-info');
                if (existingViolationsInfo) {
                    existingViolationsInfo.remove();
                }
                
                if (violationCount > 0) {
                    const violationsInfo = document.createElement('p');
                    violationsInfo.className = 'violations-info text-sm text-red-600 mt-2';
                    violationsInfo.textContent = `‚ö†Ô∏è ${violationCount} proctoring violation(s) detected during assessment`;
                    failureMessage.appendChild(violationsInfo);
                }
            }

            showLoading(message = 'Loading...') {
                // Hide all other content
                document.getElementById('preAssessment').classList.add('hidden');
                document.getElementById('assessmentContent').classList.add('hidden');
                document.getElementById('completionMessage').classList.add('hidden');
                document.getElementById('postAssessment').classList.add('hidden');
                
                // Show loading overlay
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('hidden');
                    const loadingText = loadingOverlay.querySelector('#loadingText');
                    if (loadingText) {
                        loadingText.textContent = message;
                    }
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }

            showError(message) {
                // Hide loading
                this.hideLoading();
                
                // Show error message
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.classList.remove('hidden');
                    const errorText = errorDiv.querySelector('#errorText');
                    if (errorText) {
                        errorText.textContent = message;
                    }
                } else {
                    // Create error message if it doesn't exist
                    const errorHTML = `
                        <div id="errorMessage" class="text-center p-8">
                            <div class="text-red-600 text-6xl mb-4">‚ùå</div>
                            <h2 class="text-2xl font-bold text-red-800 mb-4">Error</h2>
                            <p id="errorText" class="text-gray-600 mb-6">${message}</p>
                            <button onclick="location.reload()" class="btn-primary">
                                Try Again
                            </button>
                        </div>
                    `;
                    document.getElementById('assessmentContainer').innerHTML = errorHTML;
                }
            }

            forceStopProctoring() {
                console.log('Force stopping proctoring...');
                
                // Stop screen recording if active
                if (this.proctoringSystem && this.proctoringSystem.mediaRecorder) {
                    try {
                        if (this.proctoringSystem.mediaRecorder.state === 'recording') {
                            this.proctoringSystem.mediaRecorder.stop();
                        }
                    } catch (error) {
                        console.error('Error stopping media recorder:', error);
                    }
                }
                
                // Clear any proctoring intervals
                if (this.proctoringSystem && this.proctoringSystem.heartbeatInterval) {
                    clearInterval(this.proctoringSystem.heartbeatInterval);
                }
                
                // Update proctoring status display
                const proctoringStatus = document.getElementById('proctoringStatus');
                if (proctoringStatus) {
                    proctoringStatus.classList.remove('recording');
                    proctoringStatus.classList.add('stopped');
                    proctoringStatus.textContent = 'Proctoring Stopped';
                }
                
                console.log('Proctoring force stopped');
            }

            showCompletionMessage() {
                // Hide assessment content
                document.getElementById('assessmentContent').classList.add('hidden');
                
                // Show completion message
                document.getElementById('completionMessage').classList.remove('hidden');
                
                // Stop the timer
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                
                // Stop proctoring
                if (this.proctoringSystem) {
                    this.proctoringSystem.completeAssessment(85, true); // Mock score for now
                }
            }

            startTimer() {
                this.timerInterval = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timeRemaining <= 0) {
                        this.timeUp();
                    }
                }, 1000);
                
                document.getElementById('timer').classList.remove('hidden');
                this.updateTimerDisplay();
            }

            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timeRemaining').textContent = timeString;
                
                // Add warning class when time is running low
                const timerElement = document.getElementById('timer');
                if (this.timeRemaining <= 300) { // 5 minutes
                    timerElement.classList.add('warning');
                }
            }

            timeUp() {
                clearInterval(this.timerInterval);
                this.completeAssessment(0, false, 'Time limit exceeded');
            }

            async completeAssessment(score, passed, reason = '') {
                try {
                    // Stop proctoring
                    await this.proctoringSystem.completeAssessment(score, passed);
                    
                    // Stop timer
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                    }
                    
                    // Hide assessment content, show results
                    document.getElementById('assessmentContent').classList.add('hidden');
                    document.getElementById('postAssessment').classList.remove('hidden');
                    
                    if (passed) {
                        document.getElementById('successMessage').classList.remove('hidden');
                        document.getElementById('finalScore').textContent = score;
                    } else {
                        document.getElementById('failureMessage').classList.remove('hidden');
                        document.getElementById('userScore').textContent = score;
                        document.getElementById('requiredScore').textContent = this.assessmentConfig.passingScore;
                    }
                    
                    // Send completion to server
                    await this.sendAssessmentCompletion(score, passed, reason);
                    
                } catch (error) {
                    console.error('Failed to complete assessment:', error);
                    this.showError('Failed to complete assessment');
                }
            }

            async sendAssessmentCompletion(score, passed, reason) {
                try {
                    const response = await fetch('/api/assessment/complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            assessmentId: this.assessmentId,
                            sessionId: this.sessionId,
                            score,
                            passed,
                            reason,
                            timeSpent: (this.assessmentConfig.timeLimit * 60) - this.timeRemaining
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send completion data');
                    }
                    
                } catch (error) {
                    console.error('Error sending completion:', error);
                }
            }

            showError(message) {
                alert('Error: ' + message);
            }
            
            showNotification(message, type = 'info') {
                // Create notification element if it doesn't exist
                let notification = document.getElementById('notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'notification';
                    notification.className = 'fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full';
                    document.body.appendChild(notification);
                }
                
                // Set notification content and style based on type
                const typeClasses = {
                    'info': 'bg-blue-50 border border-blue-200 text-blue-800',
                    'success': 'bg-green-50 border border-green-200 text-green-800',
                    'warning': 'bg-yellow-50 border border-yellow-200 text-yellow-800',
                    'error': 'bg-red-50 border border-red-200 text-red-800'
                };
                
                const icons = {
                    'info': '‚ÑπÔ∏è',
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå'
                };
                
                notification.className = `fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${typeClasses[type] || typeClasses.info}`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-lg mr-2">${icons[type] || icons.info}</span>
                        <span class="text-sm font-medium">${message}</span>
                        <button onclick="this.parentElement.parentElement.classList.add('translate-x-full')" class="ml-2 text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                // Show notification
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                }, 5000);
            }

            hideLoading() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        // Initialize assessment when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AssessmentManager();
        });
    </script>
</body>
</html>
