<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
        }
        .container { 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 20px; 
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .question-card { 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
            background-color: #f8fafc; 
        }
        .option-label { 
            display: block; 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; 
        }
        .option-label:hover { 
            background-color: #eff6ff; 
            border-color: #93c5fd; 
        }
        .option-label input:checked + span { 
            background-color: #2563eb; 
            color: #fff; 
            border-color: #2563eb; 
        }
        .option-label input { 
            display: none; 
        }
        .option-label span { 
            display: block; 
            padding: 8px; 
            border-radius: 4px; 
        }
        .btn-primary { 
            background-color: #2563eb; 
            color: #fff; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .btn-primary:hover { 
            background-color: #1d4ed8; 
        }
        .btn-secondary { 
            background-color: #e2e8f0; 
            color: #1e293b; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .btn-secondary:hover { 
            background-color: #cbd5e1; 
        }
        .progress-bar { 
            height: 8px; 
            background-color: #e2e8f0; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        .progress-fill { 
            height: 100%; 
            background-color: #2563eb; 
            width: 0%; 
            transition: width 0.3s ease-in-out; 
        }
        .hidden { 
            display: none; 
        }
        .loading { 
            text-align: center; 
            padding: 40px; 
        }
        .spinner { 
            border: 4px solid #f3f4f6; 
            border-top: 4px solid #2563eb; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <h2 class="text-xl font-semibold mb-2">Loading Assessment...</h2>
            <p class="text-gray-600">Please wait while we prepare your assessment.</p>
        </div>

        <!-- Assessment Content -->
        <div id="assessmentContent" class="hidden">
            <h1 id="assessmentTitle" class="text-3xl font-bold text-center mb-6">Assessment</h1>
            <p id="assessmentDescription" class="text-center text-gray-600 mb-6"></p>

            <!-- Progress Bar and Timer -->
            <div class="mb-6">
                <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                    <span>Progress: <span id="progressText">0/0 (0%)</span></span>
                    <span>Time Elapsed: <span id="timer">00:00</span></span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span id="questionProgress">Question 0 of 0</span>
                    <span id="timeWarning" class="hidden text-red-600 font-semibold"></span>
                </div>
            </div>

            <!-- Keyboard Shortcuts Help -->
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs">
                <p class="font-semibold text-blue-900 mb-1">⌨️ Keyboard Shortcuts:</p>
                <p class="text-blue-800">→ Next Question | ← Previous Question | 1-4 Select Option | Enter Submit/Next</p>
            </div>

            <!-- Assessment Questions -->
            <div id="assessmentQuestions">
                <!-- Questions will be dynamically loaded here -->
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-6">
                <button id="prevBtn" class="btn-secondary hidden">Previous</button>
                <button id="nextBtn" class="btn-primary">Next</button>
                <button id="submitBtn" class="btn-primary hidden">Submit Assessment</button>
            </div>

            <!-- Result Display -->
            <div id="resultDisplay" class="hidden text-center mt-10 p-8 rounded-lg">
                <h2 id="resultTitle" class="text-2xl font-bold mb-4"></h2>
                <p class="text-lg mb-2">Your Score: <span id="finalScore"></span></p>
                <p class="text-gray-600" id="resultMessage"></p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center p-8">
            <div class="text-red-600 text-6xl mb-4">❌</div>
            <h2 class="text-2xl font-bold text-red-800 mb-4">Error</h2>
            <p id="errorMessage" class="text-red-600 mb-4"></p>
            <button onclick="window.close()" class="btn-primary">Close</button>
        </div>
    </div>

    <script>
        let questions = [];
        let assessmentConfig = {};
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let startTime;
        let timerInterval;
        let passingScorePercentage = 80;

        // Load assessment data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const assessmentId = urlParams.get('assessmentId');
        const sessionId = urlParams.get('sessionId');

        // Load assessment configuration
        async function loadAssessmentConfig() {
            try {
                console.log('Loading assessment config for:', assessmentId);
                const response = await fetch(`/api/assessment/config/${assessmentId}`);
                if (!response.ok) {
                    throw new Error('Failed to load assessment configuration');
                }
                assessmentConfig = await response.json();
                questions = assessmentConfig.questions || [];
                passingScorePercentage = assessmentConfig.passingScore || 80;
                userAnswers = new Array(questions.length).fill(null);
                
                console.log('Assessment config loaded:', assessmentConfig);
                console.log('Questions loaded:', questions.length);
                
                // Update UI
                document.getElementById('assessmentTitle').textContent = assessmentConfig.title || 'Assessment';
                document.getElementById('assessmentDescription').textContent = assessmentConfig.description || '';
                
            } catch (error) {
                console.error('Error loading assessment config:', error);
                showError('Failed to load assessment. Please try again.');
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('assessmentContent').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Initialize assessment
        async function initializeAssessment() {
            await loadAssessmentConfig();
            if (questions.length === 0) {
                showError('No questions found for this assessment.');
                return;
            }
            
            // Hide loading, show assessment
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('assessmentContent').classList.remove('hidden');
            
            startTimer();
            loadQuestion();
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
            const seconds = (elapsedTime % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            
            // Time warnings
            const timeLimit = (assessmentConfig.timeLimit || 30) * 60; // in seconds
            const remaining = timeLimit - elapsedTime;
            
            if (remaining <= 300 && remaining > 0) { // 5 minutes left
                const remainingMins = Math.ceil(remaining / 60);
                document.getElementById('timeWarning').textContent = `⚠️ ${remainingMins} minutes remaining!`;
                document.getElementById('timeWarning').classList.remove('hidden');
            }
            
            if (remaining <= 60 && remaining > 0) { // 1 minute left
                document.getElementById('timeWarning').textContent = `🚨 ${remaining} seconds remaining!`;
                document.getElementById('timeWarning').classList.add('animate-pulse');
            }
        }

        function loadQuestion() {
            const questionData = questions[currentQuestionIndex];
            const assessmentQuestionsDiv = document.getElementById('assessmentQuestions');
            
            assessmentQuestionsDiv.innerHTML = `
                <div class="question-card">
                    <p class="text-sm text-gray-500 mb-2">Question ${currentQuestionIndex + 1} of ${questions.length}</p>
                    <h3 class="text-lg font-semibold mb-4">${questionData.question}</h3>
                    <div class="options">
                        ${questionData.options.map((option, index) => `
                            <label class="option-label">
                                <input type="radio" name="question${currentQuestionIndex}" value="${option}">
                                <span>${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;

            // Add event listeners for radio buttons
            document.querySelectorAll(`input[name="question${currentQuestionIndex}"]`).forEach(input => {
                input.addEventListener('change', (event) => {
                    userAnswers[currentQuestionIndex] = event.target.value;
                    updateProgressBar();
                });
            });

            // Restore previous answer if exists
            if (userAnswers[currentQuestionIndex]) {
                const selectedInput = document.querySelector(`input[name="question${currentQuestionIndex}"][value="${userAnswers[currentQuestionIndex]}"]`);
                if (selectedInput) {
                    selectedInput.checked = true;
                }
            }

            updateNavigationButtons();
            updateProgressBar();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            nextBtn.classList.toggle('hidden', currentQuestionIndex === questions.length - 1);
            submitBtn.classList.toggle('hidden', currentQuestionIndex !== questions.length - 1);
        }

        function updateProgressBar() {
            const answeredQuestions = userAnswers.filter(answer => answer !== null).length;
            const progress = (answeredQuestions / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${answeredQuestions}/${questions.length} (${Math.round(progress)}%)`;
            document.getElementById('questionProgress').textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        }

        function calculateScore() {
            let correctAnswers = 0;
            questions.forEach((question, index) => {
                if (userAnswers[index] === question.correctAnswer) {
                    correctAnswers++;
                }
            });
            const scorePercentage = Math.round((correctAnswers / questions.length) * 100);
            const passed = scorePercentage >= passingScorePercentage;

            return {
                score: scorePercentage,
                rawScore: correctAnswers,
                totalQuestions: questions.length,
                passed: passed,
                timeSpent: Math.floor((Date.now() - startTime) / 1000) // in seconds
            };
        }

        function showResult(scoreData) {
            clearInterval(timerInterval);
            document.getElementById('assessmentQuestions').classList.add('hidden');
            document.getElementById('prevBtn').classList.add('hidden');
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('submitBtn').classList.add('hidden');

            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.classList.remove('hidden');
            document.getElementById('finalScore').textContent = `${scoreData.rawScore}/${scoreData.totalQuestions} (${scoreData.score}%)`;

            if (scoreData.passed) {
                resultDisplay.classList.add('bg-green-50', 'border-green-200');
                document.getElementById('resultTitle').textContent = "Assessment Passed!";
                document.getElementById('resultTitle').classList.add('text-green-600');
                document.getElementById('resultMessage').textContent = "Congratulations! You have successfully completed the assessment with a passing score.";
            } else {
                resultDisplay.classList.add('bg-red-50', 'border-red-200');
                document.getElementById('resultTitle').textContent = "Assessment Not Passed";
                document.getElementById('resultTitle').classList.add('text-red-600');
                document.getElementById('resultMessage').textContent = `Unfortunately, you did not achieve the required passing score of ${passingScorePercentage}%. Please review the material and try again.`;
            }

            // Send results to parent window
            if (window.parent) {
                window.parent.postMessage({
                    type: 'ASSESSMENT_COMPLETED',
                    data: scoreData
                }, '*');
            }
        }

        // Event Listeners
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        });

        document.getElementById('submitBtn').addEventListener('click', () => {
            // Basic validation: ensure all questions are answered
            if (userAnswers.includes(null)) {
                alert('Please answer all questions before submitting.');
                return;
            }
            const scoreData = calculateScore();
            showResult(scoreData);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Prevent shortcuts if in modal or input field
            if (document.getElementById('resultDisplay').classList.contains('hidden') === false) return;
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'ArrowRight':
                    e.preventDefault();
                    if (currentQuestionIndex < questions.length - 1) {
                        currentQuestionIndex++;
                        loadQuestion();
                    }
                    break;
                    
                case 'ArrowLeft':
                    e.preventDefault();
                    if (currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                        loadQuestion();
                    }
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (currentQuestionIndex < questions.length - 1) {
                        currentQuestionIndex++;
                        loadQuestion();
                    } else {
                        // Submit on last question
                        document.getElementById('submitBtn').click();
                    }
                    break;
                    
                case '1':
                case '2':
                case '3':
                case '4':
                    e.preventDefault();
                    const optionIndex = parseInt(e.key) - 1;
                    const radio = document.querySelector(`input[name="question${currentQuestionIndex}"]:nth-of-type(${optionIndex + 1})`);
                    if (radio) {
                        radio.checked = true;
                        userAnswers[currentQuestionIndex] = radio.value;
                        updateProgressBar();
                    }
                    break;
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeAssessment);
    </script>
</body>
</html>
